# Per-PR preview services
#
# Parameterized with PR_NUMBER env var. Each PR gets its own:
# - pgr-services (built from PR branch, OTEL-traced)
# - digit-ui (built from PR branch)
# - jupyter (built from PR branch)
#
# IMPORTANT: This file is invoked as the sole -f, so relative paths resolve
# from .github/pr-preview/ (this file's directory).
#
# Usage:
#   PR_NUMBER=42 docker compose -f .github/pr-preview/docker-compose.pr.yml \
#     -p pr-42 up -d
#
# Container names follow the convention pgr-services-pr<N>, digit-ui-pr<N>,
# jupyter-pr<N> â€” which nginx auto-discovers via Docker DNS.

services:
  pgr-services:
    image: ccrs/pgr-services:pr-${PR_NUMBER}
    container_name: pgr-services-pr${PR_NUMBER}
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://${DB_HOST:-docker-postgres}:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "3"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "1"
      SPRING_FLYWAY_ENABLED: 'false'
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_HOST:-digit-redpanda}:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_HOST:-digit-redpanda}:9092
      # Unique consumer group per PR to avoid message stealing
      SPRING_KAFKA_CONSUMER_GROUP_ID: egov-pgr-services-pr${PR_NUMBER}
      SERVER_PORT: 8080
      EGOV_IDGEN_HOST: http://egov-idgen:8088/
      EGOV_WORKFLOW_HOST: http://egov-workflow-v2:8109/
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      EGOV_LOCALIZATION_HOST: http://egov-localization:8096/
      EGOV_USER_HOST: http://egov-user:8107/
      EGOV_LOCATION_HOST: http://boundary-service:8081/
      EGOV_HRMS_HOST: http://egov-hrms:8092/
      EGOV_URL_SHORTNER_HOST: http://egov-url-shortening:8080/
      EGOV_UI_APP_HOST: https://pr-${PR_NUMBER}.preview.egov.theflywheel.in
      NOTIFICATION_SMS_ENABLED: 'false'
      NOTIFICATION_EMAIL_ENABLED: 'false'
      NEW_COMPLAINT_ENABLED: 'true'
      REASSIGN_COMPLAINT_ENABLED: 'true'
      REOPEN_COMPLAINT_ENABLED: 'true'
      COMMENT_BY_EMPLOYEE_NOTIF_ENABLED: 'false'
      NOTIFICATION_ALLOWED_ON_STATUS: 'open,assigned,rejected,resolved'
      EGOV_USR_EVENTS_NOTIFICATION_ENABLED: 'true'
      EGOV_USR_EVENTS_CREATE_TOPIC: persist-user-events-async
      PGR_STATELEVEL_TENANTID: pg
      STATE_LEVEL_TENANT_ID: pg
      EGOV_STATE_LEVEL_TENANT_ID: pg
      JAVA_TOOL_OPTIONS: -Xmx192m -Xms192m
      # OTEL tracing (enable by setting OTEL_COLLECTOR env var)
      OTEL_TRACES_EXPORTER: ${OTEL_TRACES_EXPORTER:-none}
      OTEL_EXPORTER_OTLP_ENDPOINT: http://${OTEL_COLLECTOR:-digit-otel-collector}:4317
      OTEL_SERVICE_NAME: pgr-services-pr${PR_NUMBER}
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/pgr-services/health >/dev/null 2>&1 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.5'
    networks:
      - egov-network

  digit-ui:
    image: ccrs/digit-ui:pr-${PR_NUMBER}
    container_name: digit-ui-pr${PR_NUMBER}
    volumes:
      - ./nginx/digit-ui-pr.conf:/etc/nginx/conf.d/default.conf:ro
      - ../../local-setup/nginx/globalConfigs.js:/var/web/digit-ui/globalConfigs.js:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:80/digit-ui/ >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
    networks:
      - egov-network

  jupyter:
    image: ccrs/jupyter:pr-${PR_NUMBER}
    container_name: jupyter-pr${PR_NUMBER}
    user: root
    environment:
      DIGIT_URL: http://kong-gateway:8000
      DIGIT_DIRECT_MDMS: http://egov-mdms-service:8094
      DIGIT_DIRECT_USER: http://egov-user:8107
      DIGIT_DIRECT_PGR: http://pgr-services-pr${PR_NUMBER}:8080
      DIGIT_TENANT: pg
      JUPYTER_ENABLE_LAB: "yes"
    command: >
      jupyter lab
      --ip=0.0.0.0
      --port=8888
      --no-browser
      --allow-root
      --ServerApp.token=pr${PR_NUMBER}
      --ServerApp.password=''
      --ServerApp.base_url=/jupyter
      --ServerApp.allow_origin='*'
    volumes:
      - ../../local-setup/jupyter/dataloader/templates:/home/jovyan/work/templates:ro
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    networks:
      - egov-network

networks:
  egov-network:
    external: true
    name: ${EGOV_NETWORK:-local-setup_egov-network}
