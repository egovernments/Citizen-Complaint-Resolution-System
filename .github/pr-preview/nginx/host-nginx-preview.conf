# Host nginx config for *.preview.egov.theflywheel.in
#
# Install:
#   cp .github/pr-preview/nginx/host-nginx-preview.conf \
#     /etc/nginx/sites-available/preview.egov.theflywheel.in
#   ln -sf /etc/nginx/sites-available/preview.egov.theflywheel.in \
#     /etc/nginx/sites-enabled/
#   nginx -t && systemctl reload nginx
#
# Then obtain wildcard cert:
#   certbot certonly --dns-digitalocean \
#     --dns-digitalocean-credentials /etc/letsencrypt/digitalocean.ini \
#     -d '*.preview.egov.theflywheel.in' \
#     --preferred-challenges dns-01
#
# After cert is obtained, uncomment the SSL server block below and reload.

# HTTP → HTTPS redirect
server {
    listen 80;
    server_name *.preview.egov.theflywheel.in;
    return 301 https://$host$request_uri;
}

# HTTPS — proxy to Docker pr-nginx-proxy container
server {
    listen 443 ssl;
    server_name *.preview.egov.theflywheel.in;

    ssl_certificate /etc/letsencrypt/live/preview.egov.theflywheel.in/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/preview.egov.theflywheel.in/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    client_max_body_size 10m;

    location / {
        proxy_pass http://127.0.0.1:18900;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 90s;

        # WebSocket support (Jupyter, Grafana)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
