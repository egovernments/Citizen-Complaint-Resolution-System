# PR Preview routing — routes to the active PR deployment.
#
# Uses standard container names from the PR's own docker-compose.yml.
# One active PR at a time (container names are fixed: pgr-services,
# digit-ui, digit-jupyter).
#
# The PR number in the URL is captured but routing goes to the same
# containers regardless — this keeps the Vercel-style URL scheme while
# using the PR's own compose stack directly.

# --- PR routing ---
server {
    listen 80;
    server_name ~^pr-(?<prnum>\d+)\.preview\.egov\.theflywheel\.in$;

    resolver 127.0.0.11 valid=10s ipv6=off;
    client_max_body_size 10m;

    # Root redirect to UI
    location = / {
        return 302 https://$host/digit-ui/;
    }

    # PGR services API
    set $pgr pgr-services;
    location /pgr-services/ {
        proxy_pass http://$pgr:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_read_timeout 90s;
    }

    # DIGIT UI (SPA)
    set $ui digit-ui;
    location /digit-ui/ {
        proxy_pass http://$ui:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # Jupyter Lab (needs WebSocket support)
    set $jup digit-jupyter;
    location /jupyter/ {
        proxy_pass http://$jup:8888;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
    }

    # Everything else goes to shared Kong gateway (core DIGIT APIs)
    set $kong kong-gateway;
    location / {
        proxy_pass http://$kong:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_read_timeout 90s;
    }
}

# --- Shared Grafana (observability dashboard) ---
server {
    listen 80;
    server_name grafana.preview.egov.theflywheel.in;

    resolver 127.0.0.11 valid=10s ipv6=off;
    set $grafana_upstream grafana;

    location / {
        proxy_pass http://$grafana_upstream:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# --- Default server ---
server {
    listen 80 default_server;
    server_name _;

    location = /tls-check {
        if ($arg_domain ~* "^(pr-\d+|grafana)\.preview\.egov\.theflywheel\.in$") {
            return 200 "OK";
        }
        return 404 "Unknown domain";
    }

    location / {
        return 444;
    }
}
