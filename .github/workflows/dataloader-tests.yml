name: DataLoader E2E Tests

on:
  push:
    branches: [main, develop, feature/*]
    paths:
      - 'utilities/crs_dataloader/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'utilities/crs_dataloader/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'unified-dev'
        type: choice
        options:
          - unified-dev
          - chakshu

env:
  PYTHON_VERSION: '3.12'

jobs:
  test-dataloader:
    name: Run DataLoader E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: utilities/crs_dataloader/requirements.txt

      - name: Install dependencies
        working-directory: utilities/crs_dataloader
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-timeout

      - name: Set environment variables
        run: |
          # Default to unified-dev environment
          ENV="${{ github.event.inputs.environment || 'unified-dev' }}"

          if [ "$ENV" = "unified-dev" ]; then
            echo "DIGIT_URL=https://unified-dev.digit.org" >> $GITHUB_ENV
            echo "DIGIT_TENANT=statea.citya" >> $GITHUB_ENV
          else
            echo "DIGIT_URL=https://chakshu-digit.egov.theflywheel.in" >> $GITHUB_ENV
            echo "DIGIT_TENANT=statea" >> $GITHUB_ENV
          fi

      - name: Run E2E Tests
        working-directory: utilities/crs_dataloader
        env:
          # Public test credentials for chakshu dev environment
          DIGIT_USERNAME: ADMIN
          DIGIT_PASSWORD: eGov@123
        run: |
          echo "Testing against: $DIGIT_URL"
          echo "Tenant: $DIGIT_TENANT"

          # Run tests with timeout
          python test_crs_loader_e2e.py

      - name: Test Summary
        if: always()
        run: |
          echo "### DataLoader E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.DIGIT_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tenant:** ${{ env.DIGIT_TENANT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python:** ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY

  lint-python:
    name: Lint Python Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linters
        run: pip install flake8

      - name: Run flake8
        working-directory: utilities/crs_dataloader
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv
