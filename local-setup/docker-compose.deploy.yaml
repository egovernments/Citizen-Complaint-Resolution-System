# docker-compose.deploy.yaml
# Same as docker-compose.yml but WITHOUT resource limits.
# Use for deployment on machines with ample CPU/RAM.
#
# Usage: docker compose -f docker-compose.deploy.yaml up -d

services:
  # PostgreSQL with pre-loaded data (no migrations needed)
  postgres-db:
    image: postgres:16
    container_name: docker-postgres
    environment:
      POSTGRES_USER: egov
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      POSTGRES_DB: egov
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/full-dump.sql:/docker-entrypoint-initdb.d/01-full-dump.sql:ro
    ports:
      - 15432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U egov"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - egov-network

  # PgBouncer - connection pooler
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: digit-pgbouncer
    environment:
      DB_HOST: postgres-db
      DB_PORT: 5432
      DB_USER: egov
      DB_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      DB_NAME: egov
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 500
      DEFAULT_POOL_SIZE: 20
      MIN_POOL_SIZE: 5
      RESERVE_POOL_SIZE: 5
      AUTH_TYPE: scram-sha-256
    depends_on:
      postgres-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432", "-U", "egov"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      egov-network:
        aliases:
          - postgres

  redis:
    image: redis:7.2.4
    container_name: digit-redis
    ports:
      - 16379:6379
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - egov-network

  redpanda:
    image: redpandadata/redpanda:v24.1.1
    container_name: digit-redpanda
    command:
      - redpanda
      - start
      - --smp
      - '1'
      - --memory
      - 256M
      - --overprovisioned
      - --node-id
      - '0'
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092
      - --pandaproxy-addr
      - PLAINTEXT://0.0.0.0:8082
      - --advertise-pandaproxy-addr
      - PLAINTEXT://redpanda:8082
    ports:
      - 19092:9092
      - 18082:8082
    healthcheck:
      test: ["CMD", "rpk", "cluster", "health"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      egov-network:
        aliases:
          - kafka
          - kafka-v2.kafka-cluster

  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: digit-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    ports:
      - 19000:9000
      - 19001:9001
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - egov-network

  minio-init:
    image: minio/mc:RELEASE.2024-01-16T16-06-34Z
    container_name: digit-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing myminio/egov-rainmaker;
      mc anonymous set download myminio/egov-rainmaker;
      exit 0;
      "
    networks:
      - egov-network

  # MDMS Backend
  mdms-backend:
    image: egovio/mdms-v2:v2.9.2-4a60f20
    container_name: mdms-backend
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8094
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8094/mdms-v2/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 45s
    networks:
      - egov-network

  egov-mdms-service:
    image: nginx:alpine
    container_name: egov-mdms-service
    depends_on:
      mdms-backend:
        condition: service_healthy
    volumes:
      - ./nginx/mdms-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - 18094:8094
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST 'http://localhost:8094/mdms-v2/v1/_search' -H 'Content-Type: application/json' -d '{\"RequestInfo\":{\"apiId\":\"health\"},\"MdmsCriteria\":{\"tenantId\":\"pg\",\"moduleDetails\":[{\"moduleName\":\"tenant\",\"masterDetails\":[{\"name\":\"tenants\"}]}]}}'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - egov-network

  egov-enc-service:
    image: egovio/egov-enc-service:v2.9.2-4a60f20
    container_name: egov-enc-service
    depends_on:
      egov-mdms-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      SERVER_PORT: 1234
      OTEL_TRACES_EXPORTER: none
      # DEV ONLY - override via .env or environment for non-local use
      MASTER_PASSWORD: ${ENC_MASTER_PASSWORD:-asd@#$@$!132123}
      MASTER_SALT: ${ENC_MASTER_SALT:-qweasdzx}
      MASTER_INITIALVECTOR: ${ENC_MASTER_INITIALVECTOR:-qweasdzxqwea}
      MASTER_PASSWORD_PROVIDER: software
      EGOV_MDMS_HOST: http://egov-mdms-service:8094
      EGOV_MDMS_SEARCH_ENDPOINT: /mdms-v2/v1/_search
      EGOV_STATE_LEVEL_TENANT_ID: pg
      STATE_LEVEL_TENANT_ID: pg
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    ports:
      - 11234:1234
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:1234/egov-enc-service/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - egov-network

  egov-idgen:
    image: egovio/egov-idgen:v2.9.2-4a60f20
    container_name: egov-idgen
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      MDMS_HOST: http://egov-mdms-service:8094/
      EGOV_MDMS_SEARCH_ENDPOINT: mdms-v2/v1/_search
      MDMS_SERVICE_HOST: http://egov-mdms-service:8094/
      MDMS_SERVICE_SEARCH_URI: mdms-v2/v1/_search
      AUTOCREATE_NEW_SEQ: 'true'
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8088
      OTEL_TRACES_EXPORTER: none
      MANAGEMENT_HEALTH_DB_ENABLED: 'false'
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    ports:
      - 18088:8088
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8088/egov-idgen/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - egov-network

  egov-user:
    image: egovio/egov-user:master-fa75ba8
    container_name: egov-user
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      redis:
        condition: service_healthy
      egov-enc-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      FLYWAY_ENABLED: 'false'
      KAFKA_CONFIG_BOOTSTRAP_SERVER_CONFIG: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SERVER_PORT: 8107
      EGOV_MDMS_HOST: http://egov-mdms-service:8094
      EGOV_MDMS_SEARCH_ENDPOINT: /mdms-v2/v1/_search
      MDMS_HOST: http://egov-mdms-service:8094
      MDMS_V2_HOST: http://egov-mdms-service:8094
      EGOV_MDMS_V2_HOST: http://egov-mdms-service:8094
      MDMS_SEARCH_ENDPOINT: /mdms-v2/v1/_search
      EGOV_OTP_HOST: http://egov-user:8107
      EGOV_ENC_HOST: http://egov-enc-service:1234
      EGOV_IDGEN_HOST: http://egov-idgen:8088
      EGOV_ACCESSCONTROL_HOST: http://egov-accesscontrol:8090
      EGOV_STATE_LEVEL_TENANT_ID: pg
      STATE_LEVEL_TENANT_ID: pg
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms128m -Xmx384m
    ports:
      - 18107:8107
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8107/user/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - egov-network

  egov-workflow-v2:
    image: egovio/egov-workflow-v2:v2.9.2-4a60f20
    container_name: egov-workflow-v2
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-idgen:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8109
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      EGOV_MDMS_SEARCH_ENDPOINT: mdms-v2/v1/_search
      EGOV_USER_HOST: http://egov-user:8107/
      STATE_LEVEL_TENANT_ID: pg
      EGOV_STATE_LEVEL_TENANT_ID: pg
      IS_ENVIRONMENT_CENTRAL_INSTANCE: 'false'
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx256m
    ports:
      - 18109:8109
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8109/egov-workflow-v2/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - egov-network

  egov-localization:
    image: egovio/egov-localization:v2.9.2-4a60f20
    container_name: egov-localization
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      redis:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SERVER_PORT: 8096
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx256m
    ports:
      - 18096:8096
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8096/localization/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - egov-network

  boundary-service:
    image: egovio/boundary-service:v2.9.2-4a60f20
    container_name: boundary-service
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8081
      SERVER_SERVLET_CONTEXT_PATH: /boundary-service
      EGOV_MDMS_HOST: http://egov-mdms-service:8094
      EGOV_MDMS_SEARCH_ENDPOINT: /mdms-v2/v1/_search
      EGOV_USER_HOST: http://egov-user:8107
      EGOV_IDGEN_HOST: http://egov-idgen:8088
      EGOV_LOCALIZATION_HOST: http://egov-localization:8096
      STATE_LEVEL_TENANT_ID: pg
      OTEL_TRACES_EXPORTER: none
      OTEL_INSTRUMENTATION_JDBC_ENABLED: 'false'
      MANAGEMENT_HEALTH_DB_ENABLED: 'false'
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    ports:
      - 18081:8081
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8081/boundary-service/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - egov-network

  egov-accesscontrol:
    image: egovio/egov-accesscontrol:v2.9.2-4a60f20
    container_name: egov-accesscontrol
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8090
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    ports:
      - 18090:8090
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8090/access/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - egov-network

  egov-persister:
    image: egovio/egov-persister:v2.9.2-4a60f20
    container_name: egov-persister
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8091
      EGOV_PERSIST_YML_REPO_PATH: /persister-config/
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    volumes:
      - ./configs/persister:/persister-config:ro
    ports:
      - 18091:8091
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8091/common-persist/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - egov-network

  egov-filestore:
    image: egovio/egov-filestore:v2.9.2-4a60f20
    container_name: egov-filestore
    depends_on:
      pgbouncer:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      SERVER_PORT: 8083
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
      ISS3ENABLED: 'true'
      MINIO_URL: http://minio:9000
      AWS_KEY: minioadmin
      AWS_SECRETKEY: minioadmin
      IS_BUCKET_FIXED: 'true'
      FIXED_BUCKETNAME: egov-rainmaker
      ALLOWED_FORMATS_MAP: "{jpg:{'image/jpg','image/jpeg'},jpeg:{'image/jpeg','image/jpg'},png:{'image/png'},pdf:{'application/pdf'},odt:{'application/vnd.oasis.opendocument.text'},ods:{'application/vnd.oasis.opendocument.spreadsheet'},docx:{'application/x-tika-msoffice','application/x-tika-ooxml','application/vnd.oasis.opendocument.text','application/msword'},doc:{'application/x-tika-msoffice','application/x-tika-ooxml','application/vnd.oasis.opendocument.text','application/msword'},dxf:{'text/plain','application/dxf','application/octet-stream','image/vnd.dxf','image/vnd.dxf; format=ascii','image/vnd.dxf; format=binary','image/vnd.dxb'},csv:{'text/plain'},txt:{'text/plain'},xlsx:{'application/x-tika-ooxml','application/x-tika-msoffice','application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','application/zip'},xls:{'application/x-tika-ooxml','application/x-tika-msoffice','application/vnd.ms-excel','multipart/form-data'},zip:{'application/zip','application/octet-stream'},geojson:{'application/json','text/plain','application/geo+json','multipart/form-data'},json:{'application/json','text/plain'}}"
      EGOV_MDMS_HOST: http://egov-mdms-service:8094
    ports:
      - 18084:8083
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8083/filestore/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    networks:
      - egov-network

  egov-hrms:
    image: egovio/egov-hrms:hrms-boundary-0a4e737
    container_name: egov-hrms
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
      egov-idgen:
        condition: service_healthy
      egov-user:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_CONSUMER_GROUP_ID: employee-group1
      SERVER_PORT: 8092
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
      EGOV_MDMS_HOST: http://egov-mdms-service:8094
      EGOV_IDGEN_HOST: http://egov-idgen:8088
      EGOV_USER_HOST: http://egov-user:8107
      EGOV_FILESTORE_HOST: http://egov-filestore:8083
      EGOV_LOCALIZATION_HOST: http://egov-localization:8096
      EGOV_BOUNDARY_HOST: http://boundary-service:8081
      STATE_LEVEL_TENANT_ID: pg
      EGOV_STATELEVEL_TENANT: pg
      HRMS_SYSTEM_USERNAME: INTERNAL_USER
    ports:
      - 18092:8092
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8092/egov-hrms/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 150s
    networks:
      - egov-network

  egov-bndry-mgmnt:
    image: egovio/egov-bndry-mgmnt:bndry-mgmnt-3794b8c
    container_name: egov-bndry-mgmnt
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
      egov-filestore:
        condition: service_healthy
      boundary-service:
        condition: service_healthy
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: egov
      DB_USER: egov
      DB_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      KAFKA_BROKERS: redpanda:9092
      KAFKA_BROKER_HOST: redpanda:9092
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      BOOTSTRAP_SERVERS: redpanda:9092
      REDIS_HOST: redis
      REDIS_PORT: 6379
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      EGOV_MDMS_V2_HOST: http://egov-mdms-service:8094/
      EGOV_BOUNDARY_HOST: http://boundary-service:8081/
      EGOV_FILESTORE_HOST: http://egov-filestore:8083/
      EGOV_FILESTORE_SERVICE_HOST: http://egov-filestore:8083/
      EGOV_LOCALIZATION_HOST: http://egov-localization:8096/
      STATE_LEVEL_TENANT_ID: pg
      KAFKAJS_NO_PARTITIONER_WARNING: 1
    ports:
      - 18086:8080
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('net').connect(8080, 'localhost').on('connect', () => process.exit(0)).on('error', () => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - egov-network

  egov-url-shortening:
    image: egovio/egov-url-shortening:v2.9.2-4a60f20
    container_name: egov-url-shortening
    depends_on:
      pgbouncer:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      SERVER_PORT: 8080
      OTEL_TRACES_EXPORTER: none
      OTEL_INSTRUMENTATION_JDBC_ENABLED: 'false'
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx128m
    ports:
      - 18085:8080
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/egov-url-shortening/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - egov-network

  pgr-services:
    image: egovio/pgr-services:multiarch-d448cb7
    container_name: pgr-services
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
      egov-idgen:
        condition: service_healthy
      egov-user:
        condition: service_healthy
      egov-workflow-v2:
        condition: service_healthy
      egov-localization:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_ENABLED: 'false'
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_CONSUMER_GROUP_ID: egov-pgr-services
      SERVER_PORT: 8080
      EGOV_IDGEN_HOST: http://egov-idgen:8088/
      EGOV_WORKFLOW_HOST: http://egov-workflow-v2:8109/
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      EGOV_LOCALIZATION_HOST: http://egov-localization:8096/
      EGOV_USER_HOST: http://egov-user:8107/
      EGOV_LOCATION_HOST: http://boundary-service:8081/
      EGOV_HRMS_HOST: http://egov-user:8107/
      EGOV_URL_SHORTNER_HOST: http://egov-url-shortening:8080/
      EGOV_UI_APP_HOST: http://localhost:18080
      NOTIFICATION_SMS_ENABLED: 'false'
      NOTIFICATION_EMAIL_ENABLED: 'false'
      NEW_COMPLAINT_ENABLED: 'true'
      REASSIGN_COMPLAINT_ENABLED: 'true'
      REOPEN_COMPLAINT_ENABLED: 'true'
      COMMENT_BY_EMPLOYEE_NOTIF_ENABLED: 'false'
      NOTIFICATION_ALLOWED_ON_STATUS: 'open,assigned,rejected,resolved'
      EGOV_USR_EVENTS_NOTIFICATION_ENABLED: 'true'
      EGOV_USR_EVENTS_CREATE_TOPIC: persist-user-events-async
      PGR_STATELEVEL_TENANTID: pg
      STATE_LEVEL_TENANT_ID: pg
      EGOV_STATE_LEVEL_TENANT_ID: pg
      JAVA_OPTS: '-Xmx192m -Xms192m'
      OTEL_TRACES_EXPORTER: none
    ports:
      - "18083:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/pgr-services/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - egov-network

  digit-ui:
    image: egovio/digit-ui:multiarch-d448cb7
    container_name: digit-ui
    ports:
      - "18080:80"
    volumes:
      - ./nginx/digit-ui.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/globalConfigs.js:/var/web/digit-ui/globalConfigs.js:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/digit-ui/ >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - egov-network

  kong:
    image: kong:3.6
    container_name: kong-gateway
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      KONG_STATUS_LISTEN: 0.0.0.0:8100
      KONG_MEM_CACHE_SIZE: 64m
      KONG_NGINX_WORKER_PROCESSES: 1
    volumes:
      - ./kong/kong.yml:/kong/kong.yml:ro
    ports:
      - "18000:8000"
      - "18443:8443"
      - "18001:8001"
      - "18002:8002"
      - "18100:8100"
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      egov-mdms-service:
        condition: service_healthy
      egov-user:
        condition: service_healthy
    networks:
      - egov-network

  # Seed PGR workflow business service config (one-shot init container)
  pgr-workflow-seed:
    image: curlimages/curl:latest
    container_name: pgr-workflow-seed
    depends_on:
      egov-workflow-v2:
        condition: service_healthy
    volumes:
      - ./db/pgr-workflow-config.json:/pgr-workflow-config.json:ro
    entrypoint: ["sh", "-c", "echo 'Seeding PGR workflow business service...' && HTTP_CODE=$(curl -sS -o /tmp/response.txt -w '%{http_code}' -X POST 'http://egov-workflow-v2:8109/egov-workflow-v2/egov-wf/businessservice/_create' -H 'Content-Type: application/json' -d @/pgr-workflow-config.json) && echo \"PGR workflow seed done (HTTP $HTTP_CODE)\" && cat /tmp/response.txt && echo || (echo 'PGR workflow seed FAILED' && cat /tmp/response.txt 2>/dev/null && exit 1)"]
    networks:
      - egov-network
    restart: "no"

  gatus:
    image: twinproduction/gatus:latest
    container_name: digit-gatus
    depends_on:
      pgbouncer:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
    volumes:
      - ./gatus/config.yaml:/config/config.yaml:ro
    ports:
      - "18889:8080"
    environment:
      GATUS_CONFIG_PATH: /config/config.yaml
    networks:
      - egov-network

  jupyter:
    build:
      context: ./jupyter
      dockerfile: Dockerfile
    container_name: digit-jupyter
    user: root
    depends_on:
      egov-mdms-service:
        condition: service_healthy
      egov-user:
        condition: service_healthy
      kong:
        condition: service_healthy
    environment:
      DIGIT_URL: http://kong:8000
      DIGIT_DIRECT_MDMS: http://egov-mdms-service:8094
      DIGIT_DIRECT_USER: http://egov-user:8107
      DIGIT_DIRECT_PGR: http://pgr-services:8080
      DIGIT_TENANT: pg
      JUPYTER_ENABLE_LAB: "yes"
    command: >
      jupyter lab
      --ip=0.0.0.0
      --port=8888
      --no-browser
      --allow-root
      --ServerApp.token=${JUPYTER_TOKEN:-digit-crs-local}
      --ServerApp.password=''
      --ServerApp.base_url=/jupyter
      --ServerApp.allow_origin='*'
    ports:
      - "18888:8888"
    volumes:
      - ./jupyter/dataloader/templates:/home/jovyan/work/templates
      - ./jupyter:/home/jovyan/work/dataloader
      - ./jupyter/DataLoader_v2.ipynb:/home/jovyan/work/DataLoader_v2.ipynb
    networks:
      - egov-network

networks:
  egov-network:
    driver: bridge

volumes:
  postgres_data: null
  minio_data: null
