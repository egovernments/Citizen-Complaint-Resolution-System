apiVersion: apps/v1
kind: Deployment
metadata:
  name: egov-filestore
  namespace: digit
  labels:
    app: egov-filestore
spec:
  replicas: 1
  selector:
    matchLabels:
      app: egov-filestore
  template:
    metadata:
      labels:
        app: egov-filestore
    spec:
      containers:
        - name: egov-filestore
          image: localhost:5000/egovio/egov-filestore:v2.9.2-4a60f20
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8083
          envFrom:
            - configMapRef:
                name: digit-common-env
            - secretRef:
                name: digit-db-credentials
          env:
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:otel:postgresql://postgres:5432/egov"
            - name: SERVER_PORT
              value: "8083"
            - name: ISS3ENABLED
              value: "true"
            - name: MINIO_URL
              value: "http://minio:9000"
            - name: AWS_KEY
              value: minioadmin
            - name: AWS_SECRETKEY
              value: minioadmin
            - name: IS_BUCKET_FIXED
              value: "true"
            - name: FIXED_BUCKETNAME
              value: egov-rainmaker
            - name: ALLOWED_FORMATS_MAP
              value: "{jpg:{'image/jpg','image/jpeg'},jpeg:{'image/jpeg','image/jpg'},png:{'image/png'},pdf:{'application/pdf'},odt:{'application/vnd.oasis.opendocument.text'},ods:{'application/vnd.oasis.opendocument.spreadsheet'},docx:{'application/x-tika-msoffice','application/x-tika-ooxml','application/vnd.oasis.opendocument.text','application/msword'},doc:{'application/x-tika-msoffice','application/x-tika-ooxml','application/vnd.oasis.opendocument.text','application/msword'},dxf:{'text/plain','application/dxf','application/octet-stream','image/vnd.dxf','image/vnd.dxf; format=ascii','image/vnd.dxf; format=binary','image/vnd.dxb'},csv:{'text/plain'},txt:{'text/plain'},xlsx:{'application/x-tika-ooxml','application/x-tika-msoffice','application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','application/zip'},xls:{'application/x-tika-ooxml','application/x-tika-msoffice','application/vnd.ms-excel','multipart/form-data'},zip:{'application/zip','application/octet-stream'},geojson:{'application/json','text/plain','application/geo+json','multipart/form-data'},json:{'application/json','text/plain'}}"
            - name: JAVA_TOOL_OPTIONS
              value: "-Xms64m -Xmx192m"
          resources:
            limits:
              memory: 384Mi
              cpu: "250m"
            requests:
              memory: 192Mi
              cpu: "100m"
          readinessProbe:
            httpGet:
              path: /filestore/health
              port: 8083
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 10
          livenessProbe:
            httpGet:
              path: /filestore/health
              port: 8083
            initialDelaySeconds: 0
            periodSeconds: 30
            timeoutSeconds: 10
          startupProbe:
            httpGet:
              path: /filestore/health
              port: 8083
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 30
            timeoutSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: egov-filestore
  namespace: digit
spec:
  selector:
    app: egov-filestore
  ports:
    - port: 8083
      targetPort: 8083
