server
{
  listen 80;
  underscores_in_headers on;

  # Enable sub_filter for HTML injection
  sub_filter_once on;
  sub_filter_types text/html;

  location /digit-ui
  {
    root /var/web;
    index index.html index.htm;
    try_files $uri $uri/ /digit-ui/index.html;

    # Inject globalConfigs.js script tag before </head>
    sub_filter '</head>' '<script src="/digit-ui/globalConfigs.js"></script></head>';
  }

  # Serve globalConfigs.js
  location = /digit-ui/globalConfigs.js {
    alias /var/web/digit-ui/globalConfigs.js;
    default_type application/javascript;
  }

  # Proxy DIGIT API calls to Kong so UI also works on direct digit-ui port (:18080)
  location ~ ^/(mdms-v2|localization|egov-location|egov-workflow-v2|pgr-services|filestore|egov-hrms|user|boundary-service|egov-idgen|access|common-persist|egov-bndry-mgmnt)(/|$) {
    proxy_pass http://kong:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
